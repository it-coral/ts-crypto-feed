{"version":3,"file":"/home/pioneer/work/jason/actodo_api/src/tools/group_helpers.ts","sources":["/home/pioneer/work/jason/actodo_api/src/tools/group_helpers.ts"],"names":[],"mappings":"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","sourcesContent":["import {Router, Request, Response, NextFunction} from 'express';\nimport {IRequest} from '../classes/IRequest';\nimport bookshelf from '../db/bookshelf';\nvar util = require('util');\nimport User from '../db/models/user';\nimport Group from '../db/models/group';\nimport ActionType from '../db/models/action_type';\n\n/* Check  \n    - Group exists?\n    - Group deleted?\n  */\nfunction checkGroup(req: IRequest, res: Response, next: NextFunction) {\n  return Group.getGroupWithRelated(req.params.group_id, [\n    'open_actions.creator', 'open_actions.action_type',\n    'users', 'tags', 'setting', 'creator'])\n  .then(group=>{\n    if(group==null)\n      res.status(404).json({\n        success: 0,\n        message: \"Group not found\"\n      });\n    else if(group.get('deleted_at') != null)\n      res.status(404).json({\n        success: 0,\n        message: \"The group was deleted\"\n      });\n    else{\n      req.current_group = group;\n      return next();\n    }\n  }).catch(err=>next(err));\n}\n\n\n/*\n  must ensure req.group exist.\n  Check  \n     If group is private, only return actions if calling user is a member of the group   \n  */\nfunction checkUserPermissionAccessGroup(req: IRequest, res: Response, next: NextFunction) {\n  if(req.current_group.get('private') == 1){ //if private\n    req.user.getGroupIDs().then(function(groupIDs){\n      if(groupIDs.indexOf(req.current_group.get('group_id')) == -1){\n        //If user is not a member of group\n        return res.status(403).json({\n          success: 0,\n          message: \"You are not allowed to access private group\"\n        }); \n      }\n      else{\n        return next();\n      }\n    });\n  }\n  //Otherwise  -groups is public or user belongs to private group\n  else{\n    return next();\n  }\n}\n\n\n/*\n  must ensure req.body.action_type_id exist.\n  Check  \n    return req.action_type\n  */\nfunction checkActionType(req: IRequest, res: Response, next: NextFunction) {\n  ActionType.where({action_type_id: req.body.action_type_id}).fetch()\n  .then(action_type=>{\n    if(action_type == null){\n      res.status(404).json({\n        success: 0,\n        message: \"No Action Type exist\"\n      })\n    }\n    else{\n      req.action_type = action_type;\n      next();\n    }\n  })\n  .catch(err=>{\n    next(err)\n  });\n}\n\n\n/*\n  must ensure req.group exist.\n  Check  \n     if the user is member of this group\n  */\nfunction checkUserBelongsToGroup(req: IRequest, res: Response, next: NextFunction) {\n  req.user.getGroupIDs().then(function(groupIDs){\n    if(groupIDs.indexOf(req.current_group.get('group_id')) == -1){\n      //If user is not a member of group\n      return res.status(403).json({\n        success: 0,\n        message: \"User is not member of the group\"\n      }); \n    }\n    else{\n      return next();\n    }\n  });\n}\n/*\n  must ensure req.group exist.\n  Check  \n      -Has group_user.submit_action = true\n      -OR, group_setting.allow_member_action = true and user has earned points on group actions equal to or greater than group_setting.member_action_level  \n  */\nfunction checkUserPermissionModifyGroupActions(req: IRequest, res: Response, next: NextFunction) {\n  req.user.getGroupUser(req.current_group.get('group_id'))\n  .then(groupuser=>{\n    if(groupuser.get('submit_action') == true) //if user's permission on group has submit action\n      return next();\n    else{\n      let setting = req.current_group.related('setting');\n      if(setting && setting.get('allow_member_action') == true){\n        req.user.getTotalPointsOn(req.current_group)\n        .then(point=>{\n          if(point >= req.current_group.related('setting').get('member_action_level'))\n            return next();\n          else\n            res.status(403).json({\n              success: 0,\n              message: \"You are not allowed to create action to this group\"\n            })\n        })\n      }\n      else{\n        res.status(403).json({\n          success: 0,\n          message: \"You are not allowed to create action to this group\"\n        })\n      }\n    }\n  })\n  .catch(err=>{\n    next(err)\n  });\n}\n\nmodule.exports = {\n  checkGroup,\n  checkUserPermissionAccessGroup,\n  checkUserBelongsToGroup,\n  checkActionType,\n  checkUserPermissionModifyGroupActions\n};\n"]}