{"version":3,"file":"/home/pioneer/work/jason/actodo_api/src/tools/action_helpers.ts","sources":["/home/pioneer/work/jason/actodo_api/src/tools/action_helpers.ts"],"names":[],"mappings":";AAGA,IAAI,IAAI,GAAG,OAAO,CAAC,MAAM,CAAC,CAAC;AAE3B,gDAAyC;AAEzC;;;IAGI;AACJ,qBAAqB,GAAa,EAAE,GAAa,EAAE,IAAkB;IACnE,MAAM,CAAC,gBAAM,CAAC,SAAS,CAAC,GAAG,CAAC,MAAM,CAAC,SAAS,CAAC;SAC5C,IAAI,CAAC,MAAM;QACV,EAAE,CAAA,CAAC,MAAM,IAAE,IAAI,CAAC;YACd,GAAG,CAAC,MAAM,CAAC,GAAG,CAAC,CAAC,IAAI,CAAC;gBACnB,OAAO,EAAE,CAAC;gBACV,OAAO,EAAE,kBAAkB;aAC5B,CAAC,CAAC;QACL,IAAI,CAAC,EAAE,CAAA,CAAC,MAAM,CAAC,GAAG,CAAC,YAAY,CAAC,IAAI,IAAI,CAAC;YACvC,GAAG,CAAC,MAAM,CAAC,GAAG,CAAC,CAAC,IAAI,CAAC;gBACnB,OAAO,EAAE,CAAC;gBACV,OAAO,EAAE,wBAAwB;aAClC,CAAC,CAAC;QACL,IAAI,CAAA,CAAC;YACH,GAAG,CAAC,cAAc,GAAG,MAAM,CAAC;YAC5B,MAAM,CAAC,IAAI,EAAE,CAAC;QAChB,CAAC;IACH,CAAC,CAAC,CAAC,KAAK,CAAC,GAAG,IAAE,IAAI,CAAC,GAAG,CAAC,CAAC,CAAC;AAC3B,CAAC;AAED;;;;IAII;AACJ,iCAAiC,GAAa,EAAE,GAAa,EAAE,IAAkB;IAC/E,GAAG,CAAC,IAAI,CAAC,WAAW,EAAE;SACrB,IAAI,CAAC,QAAQ;QACZ,EAAE,CAAA,CAAC,QAAQ,CAAC,OAAO,CAAC,GAAG,CAAC,cAAc,CAAC,GAAG,CAAC,UAAU,CAAC,CAAC,IAAI,CAAC,CAAC,CAAC;YAC5D,GAAG,CAAC,MAAM,CAAC,GAAG,CAAC,CAAC,IAAI,CAAC;gBACnB,OAAO,EAAE,CAAC;gBACV,OAAO,EAAE,mCAAmC;aAC7C,CAAC,CAAC;QACL,IAAI;YACF,IAAI,EAAE,CAAC;IACX,CAAC,CAAC,CAAC,KAAK,CAAC,GAAG,IAAE,IAAI,CAAC,GAAG,CAAC,CAAC,CAAC;AAC3B,CAAC;AAED;;;;;;IAMI;AACJ,sCAAsC,GAAa,EAAE,GAAa,EAAE,IAAkB;IACpF,EAAE,CAAA,CAAC,GAAG,CAAC,IAAI,CAAC,GAAG,CAAC,SAAS,CAAC,IAAI,GAAG,CAAC,cAAc,CAAC,GAAG,CAAC,oBAAoB,CAAC,CAAC;QACzE,MAAM,CAAC,IAAI,EAAE,CAAC;IAEhB,GAAG,CAAC,IAAI,CAAC,YAAY,CAAC,GAAG,CAAC,cAAc,CAAC,GAAG,CAAC,UAAU,CAAC,CAAC;SACxD,IAAI,CAAC,SAAS;QACb,EAAE,CAAA,CAAC,SAAS,CAAC,GAAG,CAAC,aAAa,CAAC,IAAI,KAAK,CAAC;YACvC,GAAG,CAAC,MAAM,CAAC,GAAG,CAAC,CAAC,IAAI,CAAC;gBACnB,OAAO,EAAE,CAAC;gBACV,OAAO,EAAE,mDAAmD;aAC7D,CAAC,CAAC;QACL,IAAI;YACF,IAAI,EAAE,CAAC;IACX,CAAC,CAAC,CAAC,KAAK,CAAC,GAAG;QACV,IAAI,CAAC,GAAG,CAAC,CAAA;IACX,CAAC,CAAC,CAAC;AAEL,CAAC;AACD,MAAM,CAAC,OAAO,GAAG;IACf,WAAW;IACX,uBAAuB;IACvB,4BAA4B;CAC7B,CAAC","sourcesContent":["import {Router, Request, Response, NextFunction} from 'express';\nimport {IRequest} from '../classes/IRequest';\nimport bookshelf from '../db/bookshelf';\nvar util = require('util');\nimport User from '../db/models/user';\nimport Action from '../db/models/action';\n\n/* Check  \n    - Action exists?\n    - Action deleted?\n  */\nfunction checkAction(req: IRequest, res: Response, next: NextFunction) {\n  return Action.getAction(req.params.action_id)\n  .then(action=>{\n    if(action==null)\n      res.status(404).json({\n        success: 0,\n        message: \"Action not found\"\n      });\n    else if(action.get('deleted_at') != null)\n      res.status(404).json({\n        success: 0,\n        message: \"The action was deleted\"\n      });\n    else{\n      req.current_action = action;\n      return next();\n    }\n  }).catch(err=>next(err));\n}\n\n/*\n  must ensure req.action exist.\n  Check  \n    - Action belongs to current user with his groups?\n  */\nfunction checkUserBelongtoAction(req: IRequest, res: Response, next: NextFunction) {\n  req.user.getGroupIDs()\n  .then(groupIDs=>{\n    if(groupIDs.indexOf(req.current_action.get('group_id')) == -1)\n      res.status(403).json({\n        success: 0,\n        message: \"User is not a member of the group\"\n      });\n    else\n      next();\n  }).catch(err=>next(err));\n}\n\n/*\n  must ensure req.action exist.\n  must ensure user belongs to group\n  Check  \n    - has group_user.mod_actions = true, OR\n    - is the action.created_by_user_id creator of the action\n  */\nfunction checkUserPermissionModAction(req: IRequest, res: Response, next: NextFunction) {\n  if(req.user.get('user_id') == req.current_action.get('created_by_user_id'))\n    return next();\n  \n  req.user.getGroupUser(req.current_action.get('group_id'))\n  .then(groupuser=>{\n    if(groupuser.get('mod_actions') == false)\n      res.status(403).json({\n        success: 0,\n        message: \"User has no permission to delete or update action\"\n      });\n    else\n      next();\n  }).catch(err=>{\n    next(err)\n  });\n    \n}\nmodule.exports = {\n  checkAction,\n  checkUserBelongtoAction,\n  checkUserPermissionModAction\n};\n"]}